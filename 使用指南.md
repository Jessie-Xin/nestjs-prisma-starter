# 🚀 NestJS Prisma Starter 使用指南

## 📋 目录

- [快速开始](#快速开始)
- [访问应用](#访问应用)
- [GraphQL API 使用](#graphql-api-使用)
  - [认证流程](#认证流程)
  - [用户操作](#用户操作)
  - [文章操作](#文章操作)
- [REST API 使用](#rest-api-使用)
- [常见问题](#常见问题)

---

## 快速开始

### 1. 安装依赖

```bash
npm install
```

### 2. 配置环境变量

复制环境变量示例文件：

```bash
cp .env.example .env
```

编辑 `.env` 文件，配置数据库连接等信息。

### 3. 启动数据库

使用 Docker 启动 PostgreSQL 数据库：

```bash
npm run docker:db
```

### 4. 运行数据库迁移

```bash
npm run migrate:dev
```

### 5. 填充种子数据

项目会自动创建以下测试用户：

```bash
npm run seed
```

**默认测试账号：**

- **管理员账号**
  - Email: `bart@simpson.com`
  - Password: `secret42`
  - Role: ADMIN

- **普通用户**
  - Email: `lisa@simpson.com`
  - Password: `secret42`
  - Role: USER

### 6. 启动应用

```bash
# 开发模式（带热重载）
npm run start:dev

# 生产模式
npm run build
npm run start:prod
```

---

## 访问应用

启动成功后，你会在终端看到：

```
🚀 应用启动成功！

📍 应用地址: http://localhost:3000
🎮 GraphQL Playground: http://localhost:3000/graphql
📚 Swagger 文档: http://localhost:3000/api
```

- **GraphQL Playground**: 主要 API 接口，用于所有业务操作
- **Swagger 文档**: REST API 文档（仅健康检查端点）
- **应用地址**: 根路径健康检查

---

## GraphQL API 使用

### 访问 GraphQL Playground

打开浏览器访问：`http://localhost:3000/graphql`

GraphQL Playground 提供：
- ✅ 自动补全
- ✅ 完整的 Schema 文档
- ✅ 查询历史
- ✅ 实时订阅测试

---

## 认证流程

### 1. 用户注册

在 GraphQL Playground 中执行：

```graphql
mutation Signup {
  signup(data: {
    email: "test@example.com",
    password: "mypassword123"
  }) {
    accessToken
    refreshToken
    user {
      id
      email
      role
    }
  }
}
```

### 2. 用户登录

使用测试账号登录：

```graphql
mutation Login {
  login(data: {
    email: "test@example.com",
    password: "mypassword123"
  }) {
    accessToken
    refreshToken
    user {
      id
      email
      firstname
      lastname
      role
    }
  }
}
```

**响应示例：**

```json
{
  "data": {
    "login": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "user": {
        "id": "clx123...",
        "email": "bart@simpson.com",
        "firstname": "Bart",
        "lastname": "Simpson",
        "role": "ADMIN"
      }
    }
  }
}
```

### 3. 设置认证 Token

登录成功后，将 `accessToken` 添加到 HTTP Headers：

1. 在 GraphQL Playground 底部找到 **HTTP HEADERS** 标签
2. 添加以下内容：

```json
{
  "Authorization": "Bearer YOUR_ACCESS_TOKEN"
}
```

**示例：**

```json
{
  "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJjbHgxMjMuLi4ifQ..."
}
```

### 4. 刷新 Token

当 `accessToken` 过期（2 分钟）后，使用 `refreshToken` 获取新的 token：

```graphql
mutation RefreshToken {
  refreshToken(token: "YOUR_REFRESH_TOKEN") {
    accessToken
    refreshToken
  }
}
```

---

## 用户操作

### 查询当前用户信息

**需要认证** 🔒

```graphql
query Me {
  me {
    id
    email
    firstname
    lastname
    role
    createdAt
    updatedAt
  }
}
```

### 更新用户信息

**需要认证** 🔒

```graphql
mutation UpdateUser {
  updateUser(data: {
    firstname: "张",
    lastname: "三"
  }) {
    id
    email
    firstname
    lastname
  }
}
```

### 修改密码

**需要认证** 🔒

```graphql
mutation ChangePassword {
  changePassword(data: {
    oldPassword: "secret42",
    newPassword: "newpassword123"
  }) {
    id
    email
  }
}
```

---

## 文章操作

### 创建文章

**需要认证** 🔒

```graphql
mutation CreatePost {
  createPost(data: {
    title: "我的第一篇文章",
    content: "这是文章内容..."
  }) {
    id
    title
    content
    published
    createdAt
    author {
      id
      email
      firstname
      lastname
    }
  }
}
```

### 查询已发布文章（分页）

**公开接口** ✅

```graphql
query PublishedPosts {
  publishedPosts(
    first: 10
    orderBy: { field: createdAt, direction: desc }
  ) {
    totalCount
    edges {
      cursor
      node {
        id
        title
        content
        createdAt
        author {
          id
          firstname
          lastname
        }
      }
    }
    pageInfo {
      hasNextPage
      hasPreviousPage
      startCursor
      endCursor
    }
  }
}
```

### 查询单篇文章

**公开接口** ✅

```graphql
query Post {
  post(postId: "POST_ID_HERE") {
    id
    title
    content
    published
    createdAt
    updatedAt
    author {
      id
      email
      firstname
      lastname
    }
  }
}
```

### 查询指定用户的文章

**需要认证** 🔒

```graphql
query UserPosts {
  userPosts(userId: "USER_ID_HERE") {
    id
    title
    content
    published
    createdAt
  }
}
```

### 更新文章

**需要认证** 🔒（只能更新自己的文章）

```graphql
mutation UpdatePost {
  updatePost(
    postId: "POST_ID_HERE"
    data: {
      title: "更新的标题",
      content: "更新的内容"
    }
  ) {
    id
    title
    content
    updatedAt
  }
}
```

### 发布文章

**需要认证** 🔒

```graphql
mutation PublishPost {
  publishPost(postId: "POST_ID_HERE") {
    id
    title
    published
  }
}
```

### 删除文章

**需要认证** 🔒（只能删除自己的文章）

```graphql
mutation DeletePost {
  deletePost(postId: "POST_ID_HERE") {
    id
    title
  }
}
```

---

## 实时订阅 (Subscriptions)

### 订阅新文章创建

在 GraphQL Playground 中测试实时订阅：

```graphql
subscription PostCreated {
  postCreated {
    id
    title
    content
    createdAt
    author {
      id
      firstname
      lastname
    }
  }
}
```

**使用步骤：**

1. 在左侧编辑器输入订阅查询
2. 点击播放按钮启动订阅
3. 在另一个标签页创建新文章
4. 回到订阅标签，可以看到实时推送的数据

---

## REST API 使用

### 健康检查

```bash
# 基础健康检查
curl http://localhost:3000

# 响应: "Hello World!"
```

### 个性化问候

```bash
curl http://localhost:3000/hello/张三

# 响应: "Hello 张三"
```

### Swagger 文档

访问 `http://localhost:3000/api` 查看完整的 REST API 文档。

---

## 常见问题

### 1. Token 过期怎么办？

**AccessToken** 有效期为 2 分钟，过期后会返回 401 错误。

**解决方法：**
- 使用 `refreshToken` mutation 获取新的 token
- RefreshToken 有效期为 7 天

### 2. 如何查看完整的 GraphQL Schema？

在 GraphQL Playground 右侧点击 **DOCS** 或 **SCHEMA** 标签，可以查看：
- 所有可用的 queries（查询）
- 所有可用的 mutations（变更）
- 所有可用的 subscriptions（订阅）
- 完整的类型定义

### 3. 为什么 Swagger 只显示两个接口？

这是正常的！本项目主要使用 **GraphQL API**，REST API 仅用于健康检查。

所有业务功能（认证、用户、文章）都通过 GraphQL 提供。

### 4. 如何重置数据库？

```bash
# 重置数据库（会删除所有数据）
npm run migrate:reset

# 重新填充种子数据
npm run seed
```

### 5. 端口被占用怎么办？

修改 `.env` 文件中的 `PORT` 变量：

```bash
PORT=3001
```

或在启动时指定：

```bash
PORT=3001 npm run start:dev
```

### 6. 如何调试 GraphQL 查询？

GraphQL Playground 提供了强大的调试功能：

- ✅ 自动补全：输入时按 `Ctrl + Space`
- ✅ 格式化：`Ctrl + Shift + F`（Windows）或 `Cmd + Shift + F`（Mac）
- ✅ 查看文档：点击右侧 DOCS 标签
- ✅ 查询历史：点击右上角时钟图标

---

## 完整使用流程示例

### 场景：创建并发布一篇文章

```graphql
# 1. 登录
mutation Login {
  login(data: {
    email: "bart@simpson.com",
    password: "secret42"
  }) {
    accessToken
    user {
      id
      email
    }
  }
}

# 2. 设置 HTTP Headers（使用上面返回的 accessToken）
# {
#   "Authorization": "Bearer YOUR_ACCESS_TOKEN"
# }

# 3. 创建文章
mutation CreatePost {
  createPost(data: {
    title: "GraphQL 入门教程",
    content: "GraphQL 是一种用于 API 的查询语言..."
  }) {
    id
    title
    published
  }
}

# 4. 发布文章（使用上面返回的文章 id）
mutation PublishPost {
  publishPost(postId: "YOUR_POST_ID") {
    id
    title
    published
  }
}

# 5. 查询已发布的文章
query PublishedPosts {
  publishedPosts(first: 10) {
    edges {
      node {
        id
        title
        content
        author {
          firstname
          lastname
        }
      }
    }
  }
}
```

---

## 技术栈

- **NestJS v11** - Node.js 框架
- **Prisma v6** - ORM 和数据库工具
- **GraphQL** - API 查询语言
- **Apollo Server v5** - GraphQL 服务器
- **PostgreSQL** - 关系型数据库
- **JWT** - 身份认证
- **TypeScript** - 类型安全

---

## 相关文档

- [NestJS 官方文档](https://docs.nestjs.com/)
- [Prisma 官方文档](https://www.prisma.io/docs/)
- [GraphQL 官方文档](https://graphql.org/learn/)
- [Apollo Server 文档](https://www.apollographql.com/docs/apollo-server/)

---

## 需要帮助？

查看项目根目录的以下文件：

- `README.md` - 项目概述和安装说明
- `CLAUDE.md` - 开发指南和编码规范
- `graphql/` - GraphQL 查询示例文件
  - `auth.graphql` - 认证相关示例
  - `user.graphql` - 用户操作示例
  - `post.graphql` - 文章操作示例

---

**祝你使用愉快！** 🎉
